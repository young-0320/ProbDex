## 실행 전 필수 설정

이 프로젝트를 실행하려면 **Google Gemini API 키**가 필요합니다.

1. **Google AI Studio에서 API 키를 발급**받으십시오.
2. `.env` 이름의 파일을 최상위 폴더(my-first-project)에 생성하고 다음과 같이 자신의 API 키를 입력하십시오.
   ```
   GEMINI_API_KEY='여기에_발급받은_API_키를_입력하십시오'
   ```
3. `.env` 파일에 키를 입력 후 꼭 저장을 하십시오.
4. user_input/input_pdf_problems폴더 내부에 분석을 원하는 파일(혹은 test_input_problem폴더의 테스트 문제)를 업로드하십시오.
5. 터미널에서 `poetry install`을 실행한 후, poetry run python -m src.my_first_project.main로 프로그램을 실행하십시오.


# ProbDex 기술 명세 및 구조 분석 보고서

## **1. 프로젝트 개요**

ProbDex는 단순한 키워드 매칭을 넘어, 수학 문제의 '개념적 원형(Conceptual Prototype)'을 분석하여 유사한 기출문제를 찾아주는 지능형 교육 보조 프로그램이다.

여러 알고리즘(TF-IDF, Cosine Similarity, Jaccard)을 통해 사용자 문제와 가장 적합한 기출문제를 추천한다.

## **2. 프로젝트 구조**

이 프로젝트는 **Poetry**를 이용한 의존성 관리와 모듈화된 패키지 구조를 따른다.

### 2.1. 폴더 구조

```
ProbDex_Project/
├── .pytest_cache                       # pytest 실행 시 생성되는 캐시 디렉토리 (테스트 속도 향상)
├── .venv                               # [Poetry] 가상 환경 디렉토리 (프로젝트 전용 라이브러리 설치 공간)
├── assets/                             # 시스템 데이터 저장소 (기출 PDF, DB, 이미지 리소스 등)
│   ├── problem_images/                 # PDF에서 페이지/문항별로 추출된 이미지 파일 저장소
│   ├── processed_pdfs/                 # 원본 PDF를 공통/선택 과목 등으로 분할 처리한 파일 저장소
│   ├── raw_problem_pdfs/               # 평가원 원본 기출 문제 PDF 파일 저장소
│   ├── base_problems.json              # 추출된 문제 메타데이터 및 AI 분석 결과 (JSON 포맷)
│   └── base_problems.xlsx              # 추출된 문제 메타데이터 및 AI 분석 결과 (Excel 포맷)
├── src/
│   └── my_first_project/               # 소스 코드 메인 패키지
│       ├── __init__.py                 # 파이썬 패키지 초기화 파일
│       ├── main.py                     # [Entry Point] 프로그램 실행 진입점 (CLI/GUI 모드 분기)
│       ├── config.py                   # 프로젝트 전역 경로, 상수, 파일명 설정 관리
│       ├── model.py                    # Pydantic 기반 데이터 모델 정의 및 유효성 검사
│       ├── engine.py                   # Gemini AI API 연동 및 프롬프트 제어 엔진 (V1)
│       ├── database.py                 # SQLite DB 스키마 생성, 연결, 기본 쿼리 함수 모음
│       ├── prob_data_processer.py      # 데이터 정제, 포맷 변환(Excel↔JSON), 텍스트 전처리 로직
│       ├── utility_pdf.py              # PDF 페이지 분할, 이미지 변환 등 유틸리티 함수
│       ├── similarity.py               # 기초 유사도 계산 알고리즘 (자카드, 텍스트 매칭)
│       ├── similarity_v2.py            # 고급 유사도 알고리즘 (TF-IDF, 코사인 유사도 적용)
│       ├── probdex_pipeline.py         # 시스템 데이터 구축 및 전체 ETL 파이프라인 관리
│       ├── user_pipeline.py            # 사용자 검색 서비스 실행 파이프라인 (초기 버전)
│       ├── user_pipeline_v2.py         # 사용자 검색 서비스 파이프라인 (개선된 로직 적용)
│       ├── user_pipeline_v3.py         # 사용자 검색 서비스 파이프라인 (최신 검색 로직 적용)
│       ├── gui_manager.py              # Tkinter 기반 GUI 인터페이스 컨트롤러 (V1)
│       └── gui_manager_v2.py           # 개선된 GUI 컨트롤러 (이미지 캐러셀, 상세 정보 표시 등)
├── user_input/                         # 사용자 데이터 관련 디렉토리
│   └── input_pdf_problems/             # 사용자가 검색을 위해 업로드하는 PDF 파일 저장소
├── .env                                # API Key(GEMINI_API_KEY) 보안 환경 변수 파일
├── poetry.lock                         # [Poetry] 의존성 패키지 버전 잠금 파일 (환경 재현성 보장)
├── pyproject.toml                      # [Poetry] 프로젝트 설정 및 의존성 명세 파일
├── probdex.db                          # [System DB] 마스터 데이터베이스 (기출 문제 원본 데이터)
├── README.md                           # 프로젝트 설명 및 실행 가이드 문서
└── user_probdex.db                     # [User DB] 사용자 검색 기록 및 분석 데이터 저장용 데이터베이스
```

### 2.2. 실행 환경

* **Dependency Management:** `Poetry`를 사용하여 라이브러리(`google-genai`, `pandas`, `scikit-learn` 등) 의존성을 관리한다.
  * 설치: `poetry install`
* **Execution:** 다음 명령어로 프로그램을 실행한다.
  * 실행: `poetry run python -m src.my_first_project.main`

## **3. 핵심 모듈**

소스 코드는 기능별로 모듈화되어 있으며, 각 파일의 역할은 다음과 같다.

### 3.1. 진입점 및 설정

* **`main.py`** : `argparse`를 사용해 `system`(DB 관리) 모드와 `user`(문제 검색) 모드를 구분하여 실행한다. `ProbDexGUI`를 초기화하고 파이프라인 콜백을 등록하여 GUI와 로직을 연결한다.
* **`config.py`** : 프로젝트 루트, 에셋 폴더, DB 경로 등을 `path` 딕셔너리로 중앙 관리하며, 연도/과목 상수를 정의한다.

### 3.2. AI 분석 엔진

* **engine.py:** `google.genai` 라이브러리를 사용해 Gemini Pro 모델과 통신한다.
* **Prompt:** AI에게 '수능 수학 분석가' 페르소나를 부여하고, 출력 형식을 Pydantic 스키마(`PDFProbResponse`)로 강제하여 JSON 파싱 오류를 최소화한다.
* **Metadata Extraction:** 문제에서 `core_concepts`(핵심 개념), `logic_flow`(논리 구조), `pattern_type`(유형), `pitfalls`(함정), `difficulty_level`(난이도) 5가지 요소를 추출한다.

### 3.3. 데이터베이스 및 모델

* **`database.py`** : `sqlite3`를 사용하여 관계형 데이터베이스를 구축한다. `problems`, `concepts`, `units`, `problem_concept_map` 테이블로 구성되며, `upsert_problem` 등의 함수로 데이터 무결성을 관리한다.
* **`model.py`** : `pydantic`을 사용하여 데이터 유효성을 검증한다. `PDFProbData` 클래스는 과목-단원 매핑이 올바른지(`validator`) 확인하여 AI의 Hallucination을 방지한다.

### 3.4. 유사도 분석

* **`similarity_v2.py`** : 추천 알고리즘의 핵심이다.
* **Text Normalization:** 특수문자 및 태그를 제거하여 텍스트를 정규화한다.
* **Advanced Score:** Jaccard 유사도(개념/태그)와 TF-IDF/Cosine 유사도(논리 구조/문장)를 결합하여 최종 점수를 산출한다.

### 3.5. 파이프라인 및 유틸리티

* **`probdex_pipeline.py`** : 시스템 초기화, PDF 전처리(분할/이미지 변환), AI 분석, DB 동기화 등 전체 ETL(Extract, Transform, Load) 과정을 관리한다.
* **`user_pipeline_v4.py`** : 사용자가 PDF를 업로드했을 때 [AI 분석 -> User DB 저장 -> 마스터 DB와 유사도 매칭 -> 결과 출력]으로 이어지는 검색 흐름을 제어한다.
* **`utility_pdf.py`** : `PyPDF2`와 `PyMuPDF(fitz)`를 사용하여 PDF를 페이지별로 자르거나 이미지(`png`)로 변환한다.

## **4. 핵심 기능 및 알고리즘**

ProbDex의 차별점은 단순 텍스트 검색이 아닌 **'의미론적 유사도(Semantic Similarity)'** 분석에 있다.

### 4.1. 메타데이터 추출

AI 엔진은 각 문제에서 다음 5가지를 추출하여 벡터화의 기초로 삼는다.

1. **Core Concepts:** 문제 해결에 필요한 핵심 수학 개념
2. **Logic Flow:** 정답 도출을 위한 사고의 단계적 흐름.
3. **Pattern Type:** 문항의 전형적 유형
4. **Pitfalls:** 학생들이 자주 범하는 실수 요인.
5. **Difficulty:** 1~5의 정수형 난이도.

### 4.2. 다차원 가중치 유사도 산출 (Weighted Similarity)

`similarity_v2.py`의 `calculate_advanced_score` 함수는 다음과 같은 가중치를 적용하여 점수를 계산한다.

| **요소**                         | **비중** | **알고리즘**         | **설명**                 |
| -------------------------------------- | -------------- | -------------------------- | ------------------------------ |
| **논리 구조 (Logic Flow)**       | **40%**  | TF-IDF + Cosine Similarity | 풀이 과정의 문맥적 유사성 분석 |
| **핵심 개념 (Core Concepts)**    | **30%**  | Jaccard Similarity         | 사용된 개념 태그 집합의 일치도 |
| **평가 목표 (Pattern/Pitfalls)** | **20%**  | Cosine Similarity          | 출제 의도 및 함정 요소 비교    |
| **난이도 (Difficulty)**          | **10%**  | Distance Based             | 난이도 차이에 따른 선형 감점   |

### 4.3. GUI 시각화

ProbDexGUI(V2)는 사용자에게 분석 과정을 투명하게 제공하고, 검색 결과를 직관적으로 전달하기 위해 Tkinter와 Pillow 라이브러리를 활용하여 개발되었다. 
단순한 결과 출력 창을 넘어, 사용자는 추천된 문제들을 상호작용하며 탐색할 수 있는 대화형 인터페이스를 경험할 수 있다.

### 4.3.1. 화면 구성 및 레이아웃

GUI 화면은 크게 시스템 로그 영역(System Log)과 추천 문제 영역(Recommended Problems)으로 구성된다.

* **상단 로그 영역:** ScrolledText 위젯을 활용하여 PDF 로딩, AI 분석 진행률, DB 쿼리 상태 등 파이프라인의 실행 과정을 실시간 텍스트로 출력한다. 이를 통해 사용자는 시스템의 동작 상태를 한눈에 확인할 수 있다.
* **하단 이미지 캐러셀(Carousel) 영역:** 검색된 문제의 원본 이미지를 시각적으로 확인할 수 있는 공간으로, 좌우 버튼(<, >)을 배치하여 사용자가 자유롭게 이미지를 넘기면서 유사도 문제를 살펴볼 수 있다.

### 4.3.2. 핵심 기술: 실시간 데이터 파싱

GUI는 백엔드 로직과 결합되어 데이터 통신 프로토콜을 수행한다.

* **표준 출력 인터셉트:** `sys.stdout`을 재정의하여 콘솔로 출력되는 모든 로그를 GUI가 가로채 분석한다.
* **구조화된 데이터 추출:** 파이프라인이 `||GUI_DATA||{이미지경로}||{점수}||…` 형식의 특정 문자열을 출력하면, GUI가 이를 즉시 감지하고 파싱한다. 이를 통해 텍스트 로그 속에 포함된 이미지 파일 경로, 유사도 점수, 원본 출처 등 메타데이터를 추출하여 시각적 요소로 변환한다.

### 4.3.3. 이미지 처리 및 정보 시각화

추출된 이미지 경로는 Pillow 라이브러리를 통해 로드되며, LANCZOS 필터를 적용한 리사이징 과정을 거쳐 화면 해상도에 최적화된 품질로 렌더링된다.

이미지 옆에는 문제의 유사도(%), 원본 출처(평가원 연도/월), 함께 추천된 문항 리스트가 요약되어 표시된다. 이를 통해 교육자는 별도의 파일을 열지 않고도 추천 결과의 적합성을 즉시 판단할 수 있다.

---

## **5. 결론**

**ProbDex**는 **Poetry** 기반 Python 환경에서 실행되며, **Gemini AI**를 활용하여 PDF 형태의 비정형 수학 문제를 교육적 의미가 반영된 구조화된 메타데이터로 변환한다. 이렇게 변환된 메타데이터는 **SQLite**에 저장된 방대한 기출 문제 데이터와 결합되어, **TF-IDF와 Cosine Similarity를 결합한 복합 알고리즘**을 통해 문제 간 유사도를 정밀하게 평가한다.

본 시스템은 단순한 키워드 매칭을 넘어, 문제의 **핵심 개념(Core Concepts), 논리 구조(Logic Flow), 패턴(Pattern), 난이도(Difficulty), 함정(Pitfalls)** 등 다차원 요소를 통합적으로 분석한다. 이를 통해 교육자는 기존의 검색 방식으로는 탐지하기 어려운, 혹은 탐지하는데 까지 오래 걸리는 **개념적 원형(Core Prototype)** 기반의 유사 문항을 효율적으로 확인할 수 있으며, 학습자 맞춤형 문제 추천과 교육 자료 설계에 유용한 도구로 활용할 수 있다.

결과적으로, ProbDex는 **정성적 분석과 정량적 알고리즘을 결합한 지능형 교육 지원 플랫폼**으로서, 수학 문제 학습과 연구, 교육자 의사결정 지원의 효율성을 크게 향상시키는 역할을 수행한다.


## **6. 향후 개선 사항 및 발전 방향**

### 6.1. 입력 데이터 지원 형식의 다각화

현재 시스템은 PDF 파일 형식의 입력만을 지원하여 사용자의 접근성이 다소 제한적이다. 이를 개선하기 위해 다음과 같이 입력 지원 범위를 확장한다.

* **이미지 파일 지원:** JPG, PNG 등 일반적인 이미지 포맷을 지원하여, 사용자가 별도의 PDF 변환 없이 촬영한 문제 사진을 바로 업로드할 수 있도록 한다.
* **모바일 환경 대응:** 모바일 기기에서의 직접 촬영 및 업로드를 지원하여 현장에서의 활용성을 극대화한다.

### 6.2. 유사도 매칭 알고리즘의 정밀도 고도화

현재 데이터베이스에 존재하는 동일한 문항을 입력하더라도, OCR 인식 오차나 텍스트 정규화 과정의 미비로 인해 유사도가 100%에 근접하지 못하는 현상이 발생한다.
이를 해결하기 위해 매칭 로직을 다음과 같이 개선한다.

* **완전 일치(Exact Match) 로직 우선 적용:** AI 분석 전 단계에서 텍스트 해시(Hash) 비교나 정규화된 문자열 비교를 선행하여, 원본 문항이 DB에 존재할 경우 즉시 100% 일치로 판별하고 불필요한 연산을 생략한다.
* **하이브리드 검색 도입:** 기존의 의미론적 검색(Vector Search)에 키워드 기반 검색(BM25 등)을 결합하여, 문맥적 유사성과 어휘적 일치성을 동시에 고려하는 하이브리드 매칭 시스템을 구축한다.

### 6.3. 웹 기반 서비스로의 확장

현재 Python `tkinter` 기반의 로컬 GUI 어플리케이션으로 구동되는 시스템을 웹 서비스로 전환한다.

* **접근성 향상:** 별도의 설치 과정 없이 브라우저를 통해 어디서든 시스템에 접근할 수 있도록 Streamlit 또는 React/Django 프레임워크를 도입하여 웹 애플리케이션화한다.
* **데이터 중앙화:** 로컬 DB(`user_probdex.db`)를 클라우드 기반 DB로 통합하여, 데이터의 일관성을 유지하고 사용자 간의 데이터 공유를 활성화한다.

### 6.4. 사용자 피드백 기반의 능동적 학습

AI 모델의 분석 결과(난이도, 핵심 개념 등)가 항상 완벽할 수는 없다. 사용자가 AI의 분석 결과를 직접 수정하거나 평가할 수 있는 피드백 루프를 구축한다.

* **데이터 품질 개선:** 사용자가 수정한 데이터를 기반으로 DB의 정합성을 지속적으로 향상시킨다.
* **모델 재학습:** 축적된 사용자 피드백 데이터를 활용하여 AI 모델을 주기적으로 재학습(Fine-tuning)시킴으로써, 도메인 특화 성능을 강화한다.

